<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Location Tracker with Route</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SENAVISION">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/image/logo.png">
    <link rel="icon" type="image/png" href="/image/logo.png">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="map.css">
    <style>
    body {
        padding: 0;
        margin: 0;
    }
    </style>
</head>
<body>
<script src="firebase-app.js"></script>
<script>
  // Require authentication before loading the heavy map script
  if (window.requireAuth) {
    window.requireAuth();
  }
  // Optionally, we could delay initializing map until auth is ready, but index.js is safe regardless
</script>
<div id="map"></div>

<!-- Permission Request Popup - Modern Design -->
<div id="permissionPopup" class="permission-popup">
  <div class="permission-content">
    <div class="permission-icon">ğŸ“</div>
    <h2>Akses Lokasi Diperlukan</h2>
    <p>Aplikasi ini memerlukan akses ke lokasi Anda saat ini untuk menampilkan:</p>
    <ul>
      <li>ğŸ“ Lokasi Anda saat ini di peta</li>
      <li>ğŸ—ºï¸ Rute dari lokasi Anda ke tujuan</li>
      <li>ğŸ“ Update lokasi setiap 1 detik (realtime)</li>
    </ul>
    <button id="requestPermissionBtn" onclick="requestLocationPermission()" class="permission-btn">
      Berikan Akses Lokasi
    </button>
    <p class="permission-hint">Setelah mengklik, browser akan meminta izin akses lokasi</p>
  </div>
</div>

<!-- Sidebar Navigation (Draggable from bottom) -->
<div id="sideNavbar" class="side-navbar">
  <!-- Drag Handle -->
  <div class="navbar-drag-handle" id="navbarDragHandle">
    <div class="drag-handle-bar"></div>
  </div>
  
  <!-- Tab Navigation -->
  <div class="navbar-tabs">
    <button class="navbar-tab active" data-tab="status" onclick="switchNavbarTab('status')">
      <span class="tab-icon">ğŸ“</span>
      <span class="tab-label">Lokasi</span>
    </button>
    <button class="navbar-tab" data-tab="voice" onclick="switchNavbarTab('voice')">
      <span class="tab-icon">ğŸ¤</span>
      <span class="tab-label">Suara</span>
    </button>
    <button class="navbar-tab" data-tab="route" onclick="switchNavbarTab('route')">
      <span class="tab-icon">ğŸ—ºï¸</span>
      <span class="tab-label">Rute</span>
    </button>
    <button class="navbar-tab" data-tab="directions" onclick="switchNavbarTab('directions')">
      <span class="tab-icon">ğŸ§­</span>
      <span class="tab-label">Petunjuk</span>
    </button>
    <button class="navbar-tab" data-tab="poi" onclick="switchNavbarTab('poi')">
      <span class="tab-icon">ğŸª</span>
      <span class="tab-label">Tempat</span>
    </button>
    <button class="navbar-tab" data-tab="debug" onclick="switchNavbarTab('debug')">
      <span class="tab-icon">ğŸ›</span>
      <span class="tab-label">Debug</span>
    </button>
  </div>
  
  <!-- Tab Content Container -->
  <div class="navbar-content">
    <!-- Status Tab Content -->
    <div id="navbarTabStatus" class="navbar-tab-content active">
      <h3><span class="icon">ğŸ“</span> Track Your Location</h3>
      <p id="status">Waiting for location...</p>
      <p id="coordinates">Lat: -, Lng: -</p>
      <p id="accuracy">Accuracy: -</p>
      
      <div class="route-info">
        <h4>Live Route Tracking</h4>
        <p>Shows route from your current location to destination</p>
        <p class="route-update-info">Route updates every 1 second (realtime)</p>
      </div>
      
      <button id="retryBtn" class="retry-button">
        <span class="btn-icon">ğŸ”„</span>
        <span>Coba Lagi</span>
      </button>
    </div>
    
    <!-- Voice Tab Content -->
    <div id="navbarTabVoice" class="navbar-tab-content">
      <h4>ğŸ¤ Navigasi Suara</h4>
      <p>Ucapkan tujuan Anda untuk bernavigasi</p>
      
      <!-- Hidden button for voice control - accessible via screen reader -->
      <button id="voiceBtn" onclick="toggleVoiceListening()" style="display: none;" aria-label="Toggle voice listening" role="button" tabindex="-1">
        ğŸ¤ Aktifkan Mikrofon
      </button>
      
      <p id="voiceStatus" class="voice-status-text">
        Senavision Siap. Ucapkan Tujuan Anda.
      </p>
      
      <div class="voice-examples">
        <p class="voice-examples-title">ğŸ’¡ Percobaan perintah suara:</p>
        <p class="voice-examples-list">
          â€¢ "Jakarta" (langsung sebutkan kota)<br>
          â€¢ "Pergi ke Bandung" juga bisa<br>
          â€¢ "Mulai" (setelah tujuan ditetapkan)
        </p>
      </div>
    </div>
    
    <!-- Route Tab Content -->
    <div id="navbarTabRoute" class="navbar-tab-content">
      <div class="route-panel-header">
        <h3><span class="icon">ğŸ—ºï¸</span> Kelola Rute</h3>
      </div>
      
      <div class="route-panel-content">
        <p class="route-panel-description">
          Atur 6 slot rute yang bisa digunakan untuk navigasi. Semua rute tersimpan di device Anda.
        </p>
        
        <!-- Route List Container -->
        <div id="routeListContainer" class="route-list-container">
          <!-- Route items will be dynamically generated here -->
        </div>
        
        <!-- Add Route Form (shown when editing) -->
        <div id="routeFormContainer" class="route-form-container" style="display: none;">
          <h4 id="routeFormTitle" class="route-form-title">Edit Rute</h4>
          <form id="routeForm" onsubmit="saveRouteFromForm(event)">
            <input type="hidden" id="routeFormId" />
            
            <div class="form-group">
              <label>ğŸ“ Lokasi Awal:</label>
              <div class="current-location-display" id="currentLocationDisplay">
                <span class="location-icon">ğŸ“</span>
                <span class="location-text" id="currentLocationText">Menggunakan lokasi saat ini</span>
              </div>
              <small class="form-hint">Lokasi awal otomatis menggunakan GPS Anda saat ini</small>
            </div>
            
            <div class="form-group">
              <label for="routeEnd">ğŸ¯ Lokasi Tujuan:</label>
              <div class="route-input-wrapper">
                <input type="text" id="routeEnd" class="route-input" placeholder="Contoh: Universitas Sebelas Maret" autocomplete="off" required />
                <!-- Autocomplete Suggestions (shown while typing) -->
                <div id="locationAutocomplete" class="location-autocomplete" style="display: none;">
                  <div id="autocompleteOptions" class="autocomplete-options">
                    <!-- Autocomplete suggestions will be dynamically generated here -->
                  </div>
                </div>
              </div>
              <small class="form-hint">Mulai ketik nama lokasi, pilih dari daftar yang muncul</small>
            </div>
            
            <div class="form-actions">
              <button type="submit" class="btn-save-route">ğŸ’¾ Simpan Rute</button>
              <button type="button" class="btn-cancel-route" onclick="cancelRouteForm()">âŒ Batal</button>
            </div>
          </form>
          
          <div id="routeFormStatus" class="route-form-status"></div>
        </div>
      </div>
    </div>
    
    <!-- Directions Tab Content -->
    <div id="navbarTabDirections" class="navbar-tab-content">
      <div class="directions-header">
        <h3><span class="icon">ğŸ§­</span> Petunjuk Arah</h3>
        <p class="directions-description">Instruksi navigasi rute Anda akan ditampilkan di sini</p>
      </div>
      
      <!-- Routing Directions Container -->
      <div id="routingDirectionsContainer" class="routing-directions-container">
        <div class="directions-placeholder">
          <p>ğŸ“ Tetapkan tujuan untuk melihat petunjuk arah</p>
        </div>
      </div>
    </div>
    
    <!-- POI Tab Content -->
    <div id="navbarTabPoi" class="navbar-tab-content">
      <div class="poi-header">
        <h3><span class="icon">ğŸª</span> Tempat Terdekat</h3>
        <p class="poi-description">Cari rumah makan, supermarket, toko elektronik, dan tempat servis di sekitar Anda</p>
      </div>
      
      <div class="poi-controls">
        <button class="poi-filter-btn active" data-type="restaurant" onclick="searchPOI('restaurant')">
          ğŸ½ï¸ Rumah Makan
        </button>
        <button class="poi-filter-btn" data-type="supermarket" onclick="searchPOI('supermarket')">
          ğŸ›’ Supermarket
        </button>
        <button class="poi-filter-btn" data-type="electronics" onclick="searchPOI('electronics')">
          ğŸ“± Elektronik
        </button>
        <button class="poi-filter-btn" data-type="service" onclick="searchPOI('service')">
          ğŸ”§ Servis
        </button>
        <button class="poi-filter-btn" data-type="all" onclick="searchPOI('all')">
          ğŸ“ Semua
        </button>
      </div>
      
      <div id="poiListContainer" class="poi-list-container">
        <div class="poi-placeholder">
          <p>ğŸ“ Klik tombol di atas untuk mencari tempat terdekat</p>
        </div>
      </div>
    </div>
    
    <!-- Debug Tab Content -->
    <div id="navbarTabDebug" class="navbar-tab-content">
      <div class="debug-header">
        <h3><span class="icon">ğŸ›</span> Debug Console</h3>
        <div class="debug-controls">
          <button id="clearDebugBtn" class="clear-debug-btn" onclick="clearDebugLogs()" title="Clear logs">ğŸ—‘ï¸ Clear</button>
          <button id="toggleAutoScrollBtn" class="auto-scroll-btn" onclick="toggleAutoScroll()" title="Toggle auto-scroll">ğŸ“œ Auto</button>
        </div>
      </div>
      
      <div id="debugLogs" class="debug-logs">
        <p class="debug-placeholder">Console logs will appear here...</p>
      </div>
    </div>
  </div>
</div>

<!-- Back to Home Button -->
<button id="backToHomeBtn" class="back-to-home-btn" onclick="goToHomePage()" title="Kembali ke Beranda">
  <span class="back-icon">ğŸ </span>
</button>

<!-- Toggle Button for Sidebar -->
<button id="navbarToggleBtn" class="navbar-toggle-btn" onclick="toggleSideNavbar()" title="Buka/Tutup Menu">
  <span class="toggle-icon">â˜°</span>
</button>

<!-- Legacy panels (hidden, kept for backward compatibility) -->
<div id="debugPanel" class="debug-panel" style="display: none;"></div>
<div id="routeManagementPanel" class="route-management-panel" style="display: none;"></div>
<div class="voice-panel" style="display: none;"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Routing Machine JS -->
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <!-- Firebase SDK (Compat) - App & Firestore -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- Firebase Init: Replace with your config -->
  <script>
  (function(){
    // IMPORTANT: Replace the placeholder below with your Firebase project config
    // Get it from Firebase Console > Project settings > General > Your apps (Web app)
    window.FIREBASE_CONFIG = window.FIREBASE_CONFIG || {
      apiKey: "AIzaSyDrKWMsQvJgtgGRvE2FEHPTnpq7MrKLQTQ",
      authDomain: "senavision-id.firebaseapp.com",
      projectId: "senavision-id",
      storageBucket: "senavision-id.firebasestorage.app",
      messagingSenderId: "1073477417711",
      appId: "1:1073477417711:web:681c33a68733fc2b35391a"
      // measurementId optional; not required for Firestore
    };

    try {
      if (window.firebase && !firebase.apps.length) {
        firebase.initializeApp(window.FIREBASE_CONFIG);
        console.log('âœ… Firebase initialized');
      }
    } catch (e) {
      console.error('âŒ Firebase init error:', e);
    }
  })();
  </script>

<!-- Hidden Canvas for Mode-Detector (background detection) -->
<div id="mode-detector-container" style="display: none; position: absolute; top: -9999px; left: -9999px; width: 1px; height: 1px; overflow: hidden;">
  <video id="video-element" autoplay playsinline muted style="display: none; width: 320px; height: 240px;"></video>
  <img id="esp32-img" crossorigin="anonymous" style="display: none; width: 320px; height: 240px;">
  <canvas id="canvas-overlay" width="320" height="240" style="display: none; width: 320px; height: 240px;"></canvas>
</div>

<!-- Mode-Detector Integration -->
<script src="mode-detector-integration.js"></script>

<!-- Custom JS -->
<script src="index.js"></script>

<!-- PWA Service Worker Registration -->
<script>
  // Register Service Worker for PWA
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then((registration) => {
          console.log('âœ… Service Worker registered successfully:', registration.scope);
          
          // Check for updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // New service worker available
                console.log('ğŸ”„ New service worker available. Reload to update.');
              }
            });
          });
        })
        .catch((error) => {
          console.warn('âŒ Service Worker registration failed:', error);
        });
    });
  }
</script>
</body>
</html>